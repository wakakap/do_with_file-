# å·¥ä½œæµçš„åç§°
name: Auto-collect YouTube Stats

on:
  # è§¦å‘å·¥ä½œæµçš„äº‹ä»¶
  schedule:
    # ä½¿ç”¨Cronè¡¨è¾¾å¼æ¥å®šæ—¶è¿è¡Œ
    # '0 15 * * *' ä»£è¡¨åœ¨æ¯å¤©çš„15:00 UTCæ—¶é—´è¿è¡Œã€‚
    # è¿™å¯¹åº”äºæ—¥æœ¬æ ‡å‡†æ—¶é—´(JST, UTC+9)çš„åˆå¤œ00:00 (15 + 9 = 24)ã€‚
    - cron: '0 15 * * *'
  
  # å…è®¸æ‚¨åœ¨Actionsé¡µé¢æ‰‹åŠ¨è§¦å‘æ­¤å·¥ä½œæµï¼Œæ–¹ä¾¿æµ‹è¯•
  workflow_dispatch:

jobs:
  collect-and-commit:
    # ä»»åŠ¡è¿è¡Œçš„è™šæ‹Ÿç¯å¢ƒ
    runs-on: ubuntu-latest

    steps:
      # ç¬¬1æ­¥ï¼šæ£€å‡ºæ‚¨çš„ä»“åº“ä»£ç 
      # ä½¿å¾—å·¥ä½œæµå¯ä»¥è®¿é—®æ‚¨çš„ collect_data.py å’Œå…¶ä»–æ–‡ä»¶
      - name: Checkout repository
        uses: actions/checkout@v4

      # ç¬¬2æ­¥ï¼šè®¾ç½®Pythonç¯å¢ƒ
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10' # æ‚¨å¯ä»¥æŒ‡å®šéœ€è¦çš„Pythonç‰ˆæœ¬

      # ç¬¬3æ­¥ï¼šå®‰è£…ä¾èµ–åº“
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # ç¬¬4æ­¥ï¼šè¿è¡Œæ•°æ®æ”¶é›†è„šæœ¬
      # å…³é”®ï¼šè¿™é‡Œæˆ‘ä»¬å°†GitHub Secretä¼ é€’ç»™è„šæœ¬æ‰€éœ€çš„ç¯å¢ƒå˜é‡
      - name: Run data collection script
        env:
          YOUTUBE_API_KEY: ${{ secrets.YOUTUBE_API_KEY }}
        run: python collect_data.py

      # ç¬¬5æ­¥ï¼šæäº¤æ›´æ–°åçš„æ•°æ®æ–‡ä»¶
      # ä½¿ç”¨ä¸€ä¸ªç°æˆçš„Actionæ¥è‡ªåŠ¨å¤„ç†gitçš„add, commit, pushæ“ä½œ
      - name: Commit and push if changed
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          # æäº¤ä¿¡æ¯
          commit_message: "ğŸ“Š Data Update: Auto-collected YouTube stats"
          # è¦æäº¤çš„æ–‡ä»¶ï¼Œè¿™é‡Œæˆ‘ä»¬åªå…³å¿ƒæ•°æ®æ–‡ä»¶
          file_pattern: "subscriber_history.csv"