<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ–‡ä»¶ç³»ç»Ÿåª’ä½“æµè§ˆå™¨</title>
    <style>
        /* CSS å˜é‡å®šä¹‰ï¼Œç”¨äºç»Ÿä¸€ç®¡ç†é¢œè‰²ã€å­—ä½“ç­‰æ ·å¼ */
        :root { --background-color: #242424; --text-color: #FFFFFF; --button-color: #3B3B3B; --button-hover-color: #888888; --card-background-color: #494141; --card-border-color: #333333; --nav-text-color: #AAAAAA; --placeholder-text-color: #CCCCCC; --font-family: 'Microsoft YaHei', 'Segoe UI', 'WenQuanYi Micro Hei', sans-serif; --label-start-r: 95; --label-start-g: 15; --label-start-b: 64; --label-end-r: 220; --label-end-g: 47; --label-end-b: 2; }
        body { background-color: var(--background-color); color: var(--text-color); font-family: var(--font-family); margin: 0; padding: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        .header-container, .nav-frame { padding: 10px 20px; flex-shrink: 0; }
        .header { display: flex; justify-content: space-between; align-items: center; }
        .header-controls { display: flex; gap: 10px; align-items: center; }
        .header-right-controls { position: relative; } /* ä¸ºç»´æŠ¤èœå•æä¾›ç›¸å¯¹å®šä½çš„å®¹å™¨ */
        .button, input[type="text"] { background-color: var(--button-color); color: var(--text-color); border: 1px solid var(--card-border-color); border-radius: 6px; padding: 8px 12px; font-size: 14px; cursor: pointer; transition: background-color 0.2s; }
        .button:hover { background-color: var(--button-hover-color); }
        input[type="text"] { width: 300px; }
        input[type="text"]::placeholder { color: var(--placeholder-text-color); }
        .nav-frame { color: var(--nav-text-color); font-size: 12px; padding-top: 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .main-content { flex-grow: 1; overflow-y: auto; padding: 0 15px 15px 15px; }
        /* å¡ç‰‡å®¹å™¨ï¼Œä½¿ç”¨ grid å¸ƒå±€å®ç°å“åº”å¼åˆ—æ•° */
        #media-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(230px, 1fr)); gap: 12px; }
        #media-container.jav-mode { grid-template-columns: repeat(auto-fill, minmax(380px, 1fr)); }
        .card { background-color: var(--card-background-color); border: 1px solid var(--card-border-color); border-radius: 8px; overflow: hidden; cursor: pointer; display: flex; flex-direction: column; }
        .card-image-wrapper { width: 100%; background-color: #1E1E1E; display: flex; justify-content: center; align-items: center; color: var(--nav-text-color); font-size: 16px; text-align: center; padding: 10px; box-sizing: border-box; }
        /* ä¸åŒæ¨¡å¼ä¸‹å°é¢çš„å®½é«˜æ¯” */
        .manga-mode .card-image-wrapper { aspect-ratio: 2 / 3; }
        .jav-mode .card-image-wrapper { aspect-ratio: 800 / 538; }
        .card-image-wrapper img { width: 100%; height: 100%; object-fit: cover; display: block; }
        .card-info { padding: 8px 12px; flex-grow: 1; display: flex; flex-direction: column; gap: 8px; }
        .card-filename { font-size: 14px; word-break: break-all; }
        .card-tags { display: flex; flex-wrap: wrap; gap: 6px; min-height: 24px; }
        .card-tag { font-size: 12px; padding: 2px 6px; border-radius: 5px; color: white; cursor: pointer; transition: transform 0.1s; }
        .card-tag:hover { transform: scale(1.05); }
        /* Tag ç¼–è¾‘æ¨¡å¼ä¸‹çš„æ ·å¼ */
        .tag-edit-unit { display: flex; align-items: center; background-color: #555; border-radius: 5px; }
        .del-tag-btn { font-size: 12px; padding: 1px 5px; margin-left:2px; background-color: #C00000; color: white; border-radius: 0 5px 5px 0; cursor: pointer; }
        .del-tag-btn:hover { background-color: red; }
        .add-tag-btn { font-size: 14px; width: 22px; height: 22px; padding: 0; line-height:22px; text-align:center; background-color: #3B3B3B; cursor:pointer; border-radius:5px; }
        .add-tag-btn:hover{ background-color: #888; }
        .open-folder-btn { position: fixed; bottom: 20px; right: 20px; z-index: 50; }
        #loading-indicator { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 24px; display: none; z-index: 2000; }
        /* ç»´æŠ¤åŠŸèƒ½çš„ä¸‹æ‹‰èœå• */
        #maintenance-menu { display: none; position: absolute; top: 100%; right: 0; background-color: var(--card-background-color); border: 1px solid var(--card-border-color); border-radius: 6px; z-index: 100; padding: 5px; min-width: 120px; }
        #maintenance-menu .button { width: 100%; text-align: left; margin-bottom: 5px; }
        #maintenance-menu .button:last-child { margin-bottom: 0; }
        /* å›¾ç‰‡/è§†é¢‘æŸ¥çœ‹å™¨çš„é®ç½©å±‚ */
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.9); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .overlay.active { display: flex; }
        .overlay .close-btn { position: absolute; top: 20px; right: 30px; font-size: 40px; color: white; cursor: pointer; z-index: 1010; text-shadow: 0 0 5px black; }
        .overlay .close-btn:hover { color: #ff4d4d; }
        #image-viewer { flex-direction: row; padding: 20px; box-sizing: border-box; }
        #image-viewer .image-container { flex-grow: 1; display: flex; justify-content: center; align-items: center; height: 100%; padding: 0; }
        #image-viewer .image-container img { max-width: 100%; max-height: 100%; object-fit: contain; opacity: 0; transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
        #image-viewer .progress-bar { width: 40px; height: 100%; display: flex; flex-direction: column; justify-content: center; padding: 0; box-sizing: border-box; gap: 1px; cursor: pointer; }
        #image-viewer .progress-segment { flex-grow: 1; width: 15px; background-color: #555; border-radius: 2px; margin: 0 auto; transition: background-color 0.2s; }
        #image-viewer .progress-segment.active { background-color: #3B8ED0; }
        #video-player video { max-width: 95vw; max-height: 95vh; outline: none; }
        #fullscreen-btn { position: absolute; top: 25px; left: 30px; font-size: 28px; color: white; cursor: pointer; z-index: 1010; text-shadow: 0 0 5px black; }
        #fullscreen-btn:hover { color: #87cefa; }
        /* â€œæ·»åŠ â€å’Œâ€œè‡ªåŠ¨å¯¼å…¥â€æŒ‰é’®çš„é€šç”¨æ ·å¼ï¼Œç¡®ä¿å®ƒä»¬èƒ½å¹¶æ’æ˜¾ç¤º */
        .add-tag-btn, .auto-import-btn { 
        font-size: 14px; width: 22px; height: 22px; padding: 0; line-height:22px; text-align:center; background-color: #3B3B3B; cursor:pointer; border-radius:5px;
        display: inline-block; /* ç¡®ä¿èƒ½å¹¶æ’æ˜¾ç¤º */
        margin-left: 4px; /* æ·»åŠ ä¸€äº›é—´è· */
        vertical-align: middle; /* å‚ç›´å±…ä¸­å¯¹é½ */ }
        .add-tag-btn:hover, .auto-import-btn:hover { background-color: #888; }
        .auto-import-btn[disabled] { cursor: not-allowed; background-color: #555; }
    </style>
</head>
<body>
    <div class="header-container">
        <div class="header">
            <div class="header-controls">
                <button id="mode-switch-btn" class="button">åˆ‡æ¢è‡³ JAV æ¨¡å¼</button>
                <input type="text" id="search-input" placeholder="è¾“å…¥å…³é”®è¯æœç´¢...">
                <button id="search-btn" class="button">æœç´¢</button>
            </div>
            <div class="header-right-controls">
                <button id="maintenance-btn" class="button">ç»´æŠ¤</button>
                <div id="maintenance-menu">
                    <button id="generate-covers-btn" class="button">ç”Ÿæˆå°é¢</button>
                    <button id="edit-tags-btn" class="button">ç¼–è¾‘Tag</button>
                </div>
            </div>
        </div>
    </div>
    <div class="nav-frame">
        <span id="current-path-label">æ­£åœ¨åŠ è½½...</span>
    </div>
    <div class="main-content">
        <div id="media-container" class="manga-mode"></div>
    </div>
    <button id="open-folder-btn" class="button open-folder-btn">æ‰“å¼€æ‰€åœ¨ç›®å½•</button>
    <div id="loading-indicator">æ­£åœ¨åŠ è½½...</div>
    <div id="image-viewer" class="overlay">
        <span id="fullscreen-btn">â›¶</span>
        <span class="close-btn">&times;</span>
        <div class="image-container">
            <img id="current-image" src="" alt="viewer image">
        </div>
        <div id="progress-bar-container" class="progress-bar"></div>
    </div>
    <div id="video-player" class="overlay">
        <span class="close-btn">&times;</span>
        <video id="current-video" controls autoplay></video>
    </div>
    <template id="card-template">
        <div class="card">
            <div class="card-image-wrapper">
                <img>
                <span class="placeholder-text"></span>
            </div>
            <div class="card-info">
                <div class="card-filename"></div>
                <div class="card-tags"></div>
            </div>
        </div>
    </template>
    
    <script>
    // ç¡®ä¿åœ¨æ•´ä¸ª DOM åŠ è½½å®Œæˆåå†æ‰§è¡Œè„šæœ¬
    document.addEventListener('DOMContentLoaded', () => {
        // --- å…ƒç´ é€‰æ‹©å™¨ï¼šè·å–æ‰€æœ‰éœ€è¦æ“ä½œçš„ HTML å…ƒç´ çš„å¼•ç”¨ ---
        const modeSwitchBtn = document.getElementById('mode-switch-btn');
        const searchInput = document.getElementById('search-input');
        const searchBtn = document.getElementById('search-btn');
        const pathLabel = document.getElementById('current-path-label');
        const mediaContainer = document.getElementById('media-container');
        const cardTemplate = document.getElementById('card-template');
        const openFolderBtn = document.getElementById('open-folder-btn');
        const loadingIndicator = document.getElementById('loading-indicator');
        // å›¾ç‰‡æŸ¥çœ‹å™¨ç›¸å…³å…ƒç´ 
        const imageViewer = document.getElementById('image-viewer');
        const imageContainer = imageViewer.querySelector('.image-container');
        const progressBarContainer = document.getElementById('progress-bar-container');
        const fullscreenBtn = document.getElementById('fullscreen-btn');
        const currentImage = document.getElementById('current-image');
        const imageViewerCloseBtn = imageViewer.querySelector('.close-btn');
        // è§†é¢‘æ’­æ”¾å™¨ç›¸å…³å…ƒç´ 
        const videoPlayer = document.getElementById('video-player');
        const currentVideo = document.getElementById('current-video');
        const videoPlayerCloseBtn = videoPlayer.querySelector('.close-btn');
        // ç»´æŠ¤åŠŸèƒ½ç›¸å…³å…ƒç´ 
        const maintenanceBtn = document.getElementById('maintenance-btn');
        const maintenanceMenu = document.getElementById('maintenance-menu');
        const generateCoversBtn = document.getElementById('generate-covers-btn');
        const editTagsBtn = document.getElementById('edit-tags-btn');

        // --- çŠ¶æ€å¯¹è±¡ï¼šé›†ä¸­ç®¡ç†åº”ç”¨çš„æ‰€æœ‰åŠ¨æ€çŠ¶æ€ ---
        let state = {
            mode: 'MANGA', // å½“å‰æ¨¡å¼: 'MANGA' æˆ– 'JAV'
            currentPath: '', // å½“å‰æµè§ˆçš„è·¯å¾„
            pathStack: [], // è·¯å¾„å†å²æ ˆï¼Œç”¨äºå®ç°è¿”å›åŠŸèƒ½
            inSearchMode: false, // æ˜¯å¦å¤„äºæœç´¢ç»“æœæ¨¡å¼
            isTagEditMode: false, // æ˜¯å¦å¤„äºTagç¼–è¾‘æ¨¡å¼
            renderingId: 0, // ç”¨äºå–æ¶ˆè¿‡æ—¶çš„æ¸²æŸ“ä»»åŠ¡
            tagsData: {}, // ä»æœåŠ¡å™¨åŠ è½½çš„åŸå§‹æ ‡ç­¾æ•°æ®
            tempTagsData: {}, // åœ¨ç¼–è¾‘æ¨¡å¼ä¸‹ä¸´æ—¶å­˜æ”¾ä¿®æ”¹çš„æ ‡ç­¾æ•°æ®
            gallery: { // å›¾ç‰‡æŸ¥çœ‹å™¨ï¼ˆç”»å»Šï¼‰çš„çŠ¶æ€
                isOpen: false,
                baseMediaPath: '', // åª’ä½“çš„åŸºç¡€è·¯å¾„ï¼Œç”¨äºæ„å»ºå›¾ç‰‡URL
                files: [], // å½“å‰ç”»å»Šçš„æ‰€æœ‰å›¾ç‰‡æ–‡ä»¶å
                currentIndex: 0, // å½“å‰æ˜¾ç¤ºçš„å›¾ç‰‡ç´¢å¼•
                isLoading: false, // æ˜¯å¦æ­£åœ¨åŠ è½½å›¾ç‰‡
            }
        };
        let activeImports = {}; // ç”¨äºè·Ÿè¸ªæ­£åœ¨è¿›è¡Œçš„è‡ªåŠ¨å¯¼å…¥æ“ä½œ
        let viewerState = { rotationAngle: 0 }; // ç‹¬ç«‹çš„çŠ¶æ€å¯¹è±¡ï¼Œç”¨äºç®¡ç†å›¾ç‰‡æŸ¥çœ‹å™¨ä¸­çš„æ—‹è½¬è§’åº¦
        let wheelDebounceTimeout = null; // ç”¨äºæ»šè½®äº‹ä»¶çš„é˜²æŠ–å®šæ—¶å™¨

        // --- æ ¸å¿ƒåŠŸèƒ½å‡½æ•° ---

        function applyImageViewerTransforms() {
            // åº”ç”¨å›¾ç‰‡æŸ¥çœ‹å™¨ä¸­çš„å˜æ¢ï¼ˆæ—‹è½¬å’Œç¼©æ”¾ï¼‰
            if (!state.gallery.isOpen) return;
            const { rotationAngle } = viewerState;
            let scale = 1;
            // å¦‚æœå›¾ç‰‡æ—‹è½¬äº†90æˆ–270åº¦ï¼Œéœ€è¦é‡æ–°è®¡ç®—ç¼©æ”¾æ¯”ä¾‹ä»¥é€‚åº”å®¹å™¨
            if (rotationAngle === 90 || rotationAngle === 270) {
                currentImage.style.maxWidth = 'none';
                currentImage.style.maxHeight = 'none';
                const img = currentImage;
                const container = imageContainer;
                if (img.naturalWidth > 0 && img.naturalHeight > 0) {
                    const scaleX = container.clientWidth / img.naturalHeight;
                    const scaleY = container.clientHeight / img.naturalWidth;
                    scale = Math.min(scaleX, scaleY); // å–è¾ƒå°çš„ç¼©æ”¾æ¯”ä¾‹ä»¥ä¿è¯å®Œæ•´æ˜¾ç¤º
                }
            } else {
                currentImage.style.maxWidth = '100%';
                currentImage.style.maxHeight = '100%';
            }
            currentImage.style.transformOrigin = `center center`;
            currentImage.style.transform = `rotate(${rotationAngle}deg) scale(${scale})`;
        }
        
        function showLoading(isLoading, clearContent = true) {
            // æ§åˆ¶åŠ è½½æŒ‡ç¤ºå™¨çš„æ˜¾ç¤ºå’Œéšè—
            loadingIndicator.style.display = isLoading ? 'block' : 'none';
            // åŠ è½½æ—¶æ ¹æ®éœ€è¦æ¸…ç©ºä¸»å†…å®¹åŒºåŸŸ
            if (isLoading && clearContent) { mediaContainer.innerHTML = ''; }
        }

        async function fetchData(url, options = {}) {
            // å°è£…çš„ fetch å‡½æ•°ï¼Œç»Ÿä¸€å¤„ç†åŠ è½½çŠ¶æ€å’Œé”™è¯¯
            const clear = options.clearContentOnLoad !== false; // é»˜è®¤åŠ è½½æ—¶æ¸…ç©ºå†…å®¹
            showLoading(true, clear);
            try {
                const response = await fetch(url, options);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                return await response.json();
            } catch (error) {
                console.error("Fetch error:", error);
                mediaContainer.innerHTML = `<p style="padding:20px;">è¼‰å…¥å¤±æ•—: ${error.message}</p>`;
                return null;
            } finally {
                showLoading(false, clear);
            }
        }
        
        async function browse(path = '') {
            // æµè§ˆç›®å½•åŠŸèƒ½
            state.renderingId++; // åˆ›å»ºæ–°çš„æ¸²æŸ“IDï¼Œä½¿æ—§çš„æ¸²æŸ“ä»»åŠ¡ä½œåºŸ
            if(state.isTagEditMode && !await confirmExitTagEditMode()) return;
            state.inSearchMode = false; searchInput.value = ''; // é€€å‡ºæœç´¢æ¨¡å¼
            const url = path ? `/api/browse?mode=${state.mode}&path=${encodeURIComponent(path)}` : `/api/browse?mode=${state.mode}`;
            const data = await fetchData(url, { clearContentOnLoad: true });
            if (data && data.items) {
                state.currentPath = data.current_path;
                // ç»´æŠ¤è·¯å¾„æ ˆï¼Œç”¨äºè¿”å›ä¸Šä¸€çº§
                if (!state.pathStack.length || state.pathStack[state.pathStack.length - 1] !== data.current_path) { state.pathStack.push(data.current_path); }
                pathLabel.textContent = `æ¨¡å¼: ${state.mode} | ${state.currentPath}`;
                mediaContainer.innerHTML = ''; // ç¡®ä¿å®¹å™¨æ¸…ç©º
                renderCardsStaggered(data.items, 0, state.renderingId); // æ¸²æŸ“å¡ç‰‡
            }
        }
        
        async function search(query, type = 'keyword') {
            // æœç´¢åŠŸèƒ½
            if (!query) return;
            state.renderingId++; // åˆ›å»ºæ–°çš„æ¸²æŸ“IDï¼Œä½¿æ—§çš„æ¸²æŸ“ä»»åŠ¡ä½œåºŸ
            if(state.isTagEditMode && !await confirmExitTagEditMode()) return;
            state.inSearchMode = true; // è¿›å…¥æœç´¢æ¨¡å¼
            const url = `/api/search?mode=${state.mode}&q=${encodeURIComponent(query)}&type=${encodeURIComponent(type)}`;
            const data = await fetchData(url, { clearContentOnLoad: true });
            if (data && data.items) {
                const searchLabel = type === 'tag' ? `æ¨™ç±¤æœç´¢: "${query}"` : `é—œéµè©æœç´¢: "${query}"`;
                pathLabel.textContent = searchLabel; // æ›´æ–°è·¯å¾„æ˜¾ç¤ºä¸ºæœç´¢ä¿¡æ¯
                mediaContainer.innerHTML = '';
                renderCardsStaggered(data.items, 0, state.renderingId);
            }
        }
        
        // --- å¡ç‰‡æ¸²æŸ“å’Œ Tag UI ---

        function renderCardsStaggered(items, index = 0, currentRenderingId) {
            // é”™å¼€æ¸²æŸ“å¡ç‰‡ï¼Œä»¥è·å¾—æ›´å¥½çš„è§†è§‰æ•ˆæœï¼Œé¿å…ä¸€æ¬¡æ€§æ¸²æŸ“å¤§é‡å¡ç‰‡å¯¼è‡´å¡é¡¿
            if (currentRenderingId !== state.renderingId) return;
            if (index >= items.length) return;
            const item = items[index];
            const cardClone = cardTemplate.content.cloneNode(true); // ä½¿ç”¨ template å…ƒç´ å…‹éš†æ–°å¡ç‰‡
            const cardEl = cardClone.querySelector('.card');
            // å°†é¡¹ç›®æ•°æ®å­˜å‚¨åœ¨å¡ç‰‡å…ƒç´ çš„ data-* å±æ€§ä¸­
            cardEl.dataset.path = item.full_path;
            cardEl.dataset.mediaPath = item.media_path;
            cardEl.dataset.isDir = item.is_dir;
            cardEl.dataset.isSpecialDir = item.is_special_dir;
            cardEl.dataset.nameNoExt = item.name_no_ext; // å­˜å‚¨ä¸å¸¦æ‰©å±•åçš„æ–‡ä»¶åï¼Œä½œä¸ºæ ‡ç­¾çš„é”®

            const imgEl = cardClone.querySelector('img');
            const placeholderEl = cardClone.querySelector('.placeholder-text');
            const filenameEl = cardClone.querySelector('.card-filename');
            
            // å¦‚æœæœ‰å°é¢ï¼Œåˆ™æ˜¾ç¤ºå°é¢ï¼›å¦åˆ™æ˜¾ç¤ºæ–‡ä»¶åä½œä¸ºå ä½ç¬¦
            if (item.cover_filename) {
                imgEl.src = `/api/media/${state.mode}/cover/${encodeURIComponent(item.cover_filename)}`;
                imgEl.style.display = 'block'; placeholderEl.style.display = 'none';
            } else {
                imgEl.style.display = 'none'; placeholderEl.style.display = 'block'; placeholderEl.textContent = item.name_no_ext;
            }
            const icon = item.is_dir ? 'ğŸ“' : 'ğŸ“„';
            const displayName = item.is_special_dir ? item.name_no_ext : item.name;
            filenameEl.textContent = `${icon} ${displayName}`;
            
            // åˆå§‹åŒ–å¡ç‰‡çš„ Tag æ˜¾ç¤º
            const tagsEl = cardClone.querySelector('.card-tags');
            updateCardTagsDisplay(tagsEl, item.name_no_ext);

            mediaContainer.appendChild(cardClone);
            // ä½¿ç”¨ setTimeout é€’å½’è°ƒç”¨ï¼Œå®ç°é”™å¼€æ¸²æŸ“
            setTimeout(() => {
                // åœ¨æ‰§è¡Œé€’å½’è°ƒç”¨ä¹‹å‰ï¼Œæ£€æŸ¥æ¸²æŸ“IDæ˜¯å¦ä»ç„¶æœ‰æ•ˆ
                if (currentRenderingId !== state.renderingId) {
                    console.log('Staggered rendering cancelled.'); // å¯ä»¥åœ¨æ§åˆ¶å°çœ‹åˆ°å–æ¶ˆæ—¥å¿—
                    return; // å¦‚æœIDå·²è¿‡æ—¶ï¼Œåˆ™ç»ˆæ­¢æ¸²æŸ“é“¾
                }
                renderCardsStaggered(items, index + 1, currentRenderingId); 
            }, 15);
        }

        function updateCardTagsDisplay(tagsContainer, itemKey) {
            // æ ¹æ®å½“å‰æ˜¯å¦ä¸ºç¼–è¾‘æ¨¡å¼ï¼Œæ›´æ–°å•ä¸ªå¡ç‰‡çš„ Tag æ˜¾ç¤ºåŒºåŸŸ
            tagsContainer.innerHTML = '';
            // æ ¹æ®æ¨¡å¼é€‰æ‹©ä½¿ç”¨ä¸´æ—¶æ•°æ®è¿˜æ˜¯åŸå§‹æ•°æ®
            const tags = state.isTagEditMode ? state.tempTagsData[itemKey] || [] : state.tagsData[itemKey] || [];
            
            if (state.isTagEditMode) {
                // ç¼–è¾‘æ¨¡å¼ä¸‹çš„ UIï¼šæ˜¾ç¤º Tag å’Œåˆ é™¤æŒ‰é’®
                tags.forEach(tag => {
                    const unit = document.createElement('div');
                    unit.className = 'tag-edit-unit';
                    const tagEl = document.createElement('span');
                    tagEl.className = 'card-tag';
                    tagEl.textContent = tag;
                    tagEl.style.backgroundColor = '#555';
                    tagEl.style.cursor = 'default';
                    const delBtn = document.createElement('span');
                    delBtn.className = 'del-tag-btn';
                    delBtn.textContent = 'Ã—';
                    delBtn.onclick = (e) => { e.stopPropagation(); deleteTag(itemKey, tag); };
                    unit.appendChild(tagEl);
                    unit.appendChild(delBtn);
                    tagsContainer.appendChild(unit);
                });
                // æ·»åŠ  "æ–°å¢Tag" æŒ‰é’®
                const addBtn = document.createElement('span');
                addBtn.className = 'add-tag-btn';
                addBtn.textContent = '+';
                addBtn.onclick = (e) => { e.stopPropagation(); addTag(itemKey); };
                tagsContainer.appendChild(addBtn);
                // --- æ–°å¢ä»£ç ï¼šåˆ›å»ºå¹¶æ·»åŠ è‡ªåŠ¨å¯¼å…¥æŒ‰é’® ---
                const importBtn = document.createElement('span');
                importBtn.className = 'auto-import-btn';
                importBtn.textContent = 'ğŸ”';
                importBtn.title = 'ä»DMMè‡ªåŠ¨å¯¼å…¥Tag';
                importBtn.onclick = (e) => {
                    e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡åˆ°å¡ç‰‡ç‚¹å‡»
                    autoImportTags(itemKey, importBtn);
                };
                tagsContainer.appendChild(importBtn);
                // --- æ–°å¢ä»£ç ç»“æŸ ---
            } else {
                // æ­£å¸¸æ¨¡å¼ä¸‹çš„ UIï¼šæ˜¾ç¤ºå¯ç‚¹å‡»çš„ã€æœ‰é¢œè‰²çš„ Tag
                tags.forEach((tag, tagIndex) => {
                    const tagEl = document.createElement('span');
                    tagEl.className = 'card-tag';
                    tagEl.textContent = tag;
                    tagEl.dataset.tag = tag;
                    // æ ¹æ® Tag çš„é¡ºåºè®¡ç®—æ¸å˜è‰²ï¼Œä½¿å…¶æœ‰åŒºåˆ†åº¦
                    const ratio = tags.length > 1 ? tagIndex / (tags.length - 1) : 0;
                    const r = Math.round(95 * (1 - ratio) + 220 * ratio);
                    const g = Math.round(15 * (1 - ratio) + 47 * ratio);
                    const b = Math.round(64 * (1 - ratio) + 2 * ratio);
                    tagEl.style.backgroundColor = `rgb(${r}, ${g}, ${b})`;
                    // ç‚¹å‡» Tag å¯ä»¥ç›´æ¥æœç´¢è¯¥ Tag
                    tagEl.onclick = (e) => { e.stopPropagation(); searchInput.value = tag; search(tag, 'tag'); };
                    tagsContainer.appendChild(tagEl);
                });
            }
        }

        function refreshAllCardsTags() {
            // åˆ·æ–°å½“å‰é¡µé¢ä¸Šæ‰€æœ‰å¡ç‰‡çš„ Tag æ˜¾ç¤ºï¼Œä¸»è¦ç”¨äºåˆ‡æ¢ç¼–è¾‘æ¨¡å¼æˆ–ä¿å­˜å
            document.querySelectorAll('.card').forEach(card => {
                const itemKey = card.dataset.nameNoExt;
                const tagsContainer = card.querySelector('.card-tags');
                if(itemKey && tagsContainer) {
                    updateCardTagsDisplay(tagsContainer, itemKey);
                }
            });
        }
        
        // --- ç»´æŠ¤åŠŸèƒ½å‡½æ•° ---

        async function enterTagEditMode() {
            // è¿›å…¥ Tag ç¼–è¾‘æ¨¡å¼
            if(state.isTagEditMode) return;
            state.isTagEditMode = true;
            // åˆ›å»ºä¸€ä¸ªæ ‡ç­¾æ•°æ®çš„æ·±æ‹·è´å‰¯æœ¬ï¼Œç”¨äºä¸´æ—¶ç¼–è¾‘ï¼Œé¿å…ç›´æ¥ä¿®æ”¹åŸå§‹æ•°æ®
            state.tempTagsData = JSON.parse(JSON.stringify(state.tagsData));
            // æ›´æ–°æŒ‰é’®çš„æ–‡æœ¬å’Œæ ·å¼ï¼Œä»¥æç¤ºå½“å‰çŠ¶æ€
            editTagsBtn.textContent = "ä¿å­˜Tag";
            editTagsBtn.style.backgroundColor = 'red';
            maintenanceBtn.textContent = 'ä¿å­˜ä¸­...';
            maintenanceBtn.style.backgroundColor = 'red';
            refreshAllCardsTags(); // åˆ·æ–°æ‰€æœ‰å¡ç‰‡ä»¥æ˜¾ç¤ºç¼–è¾‘UI
            maintenanceMenu.style.display = 'none'; // å…³é—­ä¸‹æ‹‰èœå•
        }

        async function saveAndExitTagEditMode() {
            // ä¿å­˜ Tag ä¿®æ”¹å¹¶é€€å‡ºç¼–è¾‘æ¨¡å¼
            if(!state.isTagEditMode) return;
            const options = {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(state.tempTagsData), // å°†ä¸´æ—¶æ•°æ®å‘é€åˆ°æœåŠ¡å™¨
                clearContentOnLoad: false, // ä¿å­˜æ—¶ä¸éœ€è¦æ¸…ç©ºä¸»ç•Œé¢
            };
            showLoading(true, false);
            const result = await fetch('/api/tags', options).then(res => res.json()).catch(e => ({status: 'error', message: e.toString()}));
            showLoading(false, false);

            if (result.status === 'success') {
                alert('Tag å·²æˆåŠŸä¿å­˜ï¼');
                // ä¿å­˜æˆåŠŸåï¼Œç”¨ä¸´æ—¶æ•°æ®æ›´æ–°ä¸»æ•°æ®
                state.tagsData = JSON.parse(JSON.stringify(state.tempTagsData));
                state.isTagEditMode = false;
                state.tempTagsData = {}; // æ¸…ç©ºä¸´æ—¶æ•°æ®
                // æ¢å¤æŒ‰é’®çš„åŸå§‹çŠ¶æ€
                editTagsBtn.textContent = "ç¼–è¾‘Tag";
                editTagsBtn.style.backgroundColor = '';
                maintenanceBtn.textContent = 'ç»´æŠ¤';
                maintenanceBtn.style.backgroundColor = '';
                refreshAllCardsTags(); // åˆ·æ–°æ‰€æœ‰å¡ç‰‡ä»¥æ˜¾ç¤ºæ­£å¸¸UI
            } else {
                alert(`Tag ä¿å­˜å¤±æ•—: ${result.message}`);
            }
        }

        async function confirmExitTagEditMode() {
            // åœ¨åˆ‡æ¢é¡µé¢æˆ–æ¨¡å¼æ—¶ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰æœªä¿å­˜çš„ Tag ä¿®æ”¹
            const hasChanges = JSON.stringify(state.tagsData) !== JSON.stringify(state.tempTagsData);
            if (!hasChanges) {
                // å¦‚æœæ²¡æœ‰å˜åŒ–ï¼Œåˆ™ç›´æ¥é€€å‡ºç¼–è¾‘æ¨¡å¼
                state.isTagEditMode = false;
                state.tempTagsData = {};
                editTagsBtn.textContent = "ç¼–è¾‘Tag";
                editTagsBtn.style.backgroundColor = '';
                maintenanceBtn.textContent = 'ç»´æŠ¤';
                maintenanceBtn.style.backgroundColor = '';
                refreshAllCardsTags();
                return true;
            }
            // å¦‚æœæœ‰å˜åŒ–ï¼Œå¼¹çª—ç¡®è®¤æ˜¯å¦æ”¾å¼ƒä¿®æ”¹
            if (confirm("æ‚¨æœ‰æœªä¿å­˜çš„Tagä¿®æ”¹ï¼Œç¢ºå®šè¦æ”¾æ£„å—ï¼Ÿ")) {
                 state.isTagEditMode = false;
                 state.tempTagsData = {};
                 editTagsBtn.textContent = "ç¼–è¾‘Tag";
                 editTagsBtn.style.backgroundColor = '';
                 maintenanceBtn.textContent = 'ç»´æŠ¤';
                 maintenanceBtn.style.backgroundColor = '';
                 refreshAllCardsTags();
                 return true; // ç”¨æˆ·ç¡®è®¤æ”¾å¼ƒ
            }
            return false; // ç”¨æˆ·å–æ¶ˆæ”¾å¼ƒ
        }

        function addTag(itemKey) {
            // ä¸ºæŒ‡å®šçš„é¡¹ç›®æ·»åŠ æ–° Tag
            const newTag = prompt(`ç‚º "${itemKey}" æ·»åŠ æ–°Tag:`);
            if (newTag && newTag.trim()) {
                const tag = newTag.trim();
                if (!state.tempTagsData[itemKey]) {
                    state.tempTagsData[itemKey] = [];
                }
                if (!state.tempTagsData[itemKey].includes(tag)) {
                    state.tempTagsData[itemKey].push(tag);
                    refreshAllCardsTags(); // å®æ—¶åˆ·æ–°UI
                } else {
                    alert(`Tag "${tag}" å·²ç»å­˜åœ¨ã€‚`);
                }
            }
        }

        function deleteTag(itemKey, tagToDelete) {
            // åˆ é™¤æŒ‡å®šçš„ Tag
            if (state.tempTagsData[itemKey]) {
                state.tempTagsData[itemKey] = state.tempTagsData[itemKey].filter(t => t !== tagToDelete);
                if (state.tempTagsData[itemKey].length === 0) {
                    delete state.tempTagsData[itemKey]; // å¦‚æœä¸€ä¸ªé¡¹ç›®çš„æ‰€æœ‰ Tag éƒ½è¢«åˆ é™¤ï¼Œåˆ™ç§»é™¤è¯¥é”®
                }
                refreshAllCardsTags(); // å®æ—¶åˆ·æ–°UI
            }
        }

        async function autoImportTags(itemKey, buttonEl) {
            if (activeImports[itemKey]) {
                console.log(`Cancelling import for ${itemKey}`);
                activeImports[itemKey].abort(); // å–æ¶ˆå½“å‰æ­£åœ¨è¿›è¡Œçš„å¯¼å…¥è¯·æ±‚
                return;
            }
            if (Object.keys(activeImports).length > 0 && !activeImports[itemKey]) {
                alert('å…¶ä»–çš„å¯¼å…¥æ­£åœ¨è¿›è¡Œï¼Œè¯·å…ˆå®Œæˆå½“å‰çš„Tagå¯¼å…¥æ“ä½œã€‚');
                return;
            }

            const originalText = buttonEl.textContent;
            buttonEl.disabled = true; // ç¦ç”¨æŒ‰é’®ï¼Œæ˜¾ç¤ºåŠ è½½çŠ¶æ€
            buttonEl.textContent = 'â€¦';

            // åˆ›å»ºä¸€ä¸ªæ–°çš„ AbortController å®ä¾‹ï¼Œç”¨äºå–æ¶ˆè¯·æ±‚
            const controller = new AbortController();
            activeImports[itemKey] = controller;

            try {
                // å‘åç«¯çš„ /api/auto_import_tags å‘é€è¯·æ±‚
                const response = await fetch('/api/auto_import_tags', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ item_name: itemKey }),
                    signal: controller.signal
                });
                
                delete activeImports[itemKey];

                const result = await response.json();

                if (result.status === 'success') {
                    if (!state.tempTagsData[itemKey]) {
                        state.tempTagsData[itemKey] = [];
                    }
                    const existingTags = new Set(state.tempTagsData[itemKey]);
                    let newTagsAdded = 0;
                    // å°†è·å–åˆ°çš„æ–° Tag æ·»åŠ åˆ°ä¸´æ—¶æ•°æ®ä¸­ï¼ˆå»é‡ï¼‰
                    result.tags.forEach(tag => {
                        if (!existingTags.has(tag)) {
                            state.tempTagsData[itemKey].push(tag);
                            existingTags.add(tag);
                            newTagsAdded++;
                        }
                    });
                    alert(`æˆåŠŸå¯¼å…¥ ${newTagsAdded} ä¸ªæ–°Tagï¼`);
                    refreshAllCardsTags(); // åˆ·æ–°ç•Œé¢ä»¥æ˜¾ç¤ºæ–°Tag
                } else {
                    alert(`Tagå¯¼å…¥å¤±è´¥: ${result.message}`);
                }

            } catch (error) {
                if (error.name === 'AbortError') {
                    console.log(`Import for ${itemKey} was successfully cancelled by the user.`);
                    alert(`é¡¹ç›® "${itemKey}" çš„å¯¼å…¥æ“ä½œå·²å–æ¶ˆã€‚`);
                } else {
                    console.error("Auto-import fetch error:", error);
                    alert("è‡ªåŠ¨å¯¼å…¥è¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥å’ŒæœåŠ¡å™¨æ§åˆ¶å°æ—¥å¿—ã€‚");
                }
            } finally {
                // æˆåŠŸã€å¤±è´¥æˆ–å–æ¶ˆåï¼Œæ¢å¤æŒ‰é’®çŠ¶æ€
                delete activeImports[itemKey];
                buttonEl.disabled = false;
                buttonEl.textContent = originalText;
                refreshAllCardsTags();
            }
        }

        // --- å›¾ç‰‡/è§†é¢‘æŸ¥çœ‹å™¨å’Œå¯¼èˆª ---

        function openImageViewer(fullPath, mediaPath) {
            // æ‰“å¼€å›¾ç‰‡æŸ¥çœ‹å™¨
            showLoading(true, false);
            const url = `/api/gallery?mode=${state.mode}&path=${encodeURIComponent(fullPath)}`;
            fetch(url).then(res => res.json()).then(files => {
                showLoading(false, false);
                if (files && !files.error && files.length > 0) {
                    // æ›´æ–°ç”»å»ŠçŠ¶æ€
                    state.gallery = { ...state.gallery, isOpen: true, baseMediaPath: mediaPath, files: files, currentIndex: 0, isLoading: false };
                    imageViewer.classList.add('active'); // æ˜¾ç¤ºé®ç½©å±‚
                    document.body.style.overflow = 'hidden'; // ç¦æ­¢èƒŒæ™¯æ»šåŠ¨
                    buildProgressBar(); // æ„å»ºå³ä¾§è¿›åº¦æ¡
                    displayImage(0); // æ˜¾ç¤ºç¬¬ä¸€å¼ å›¾ç‰‡
                } else { alert('é€™å€‹åœ–ç‰‡é›†æ˜¯ç©ºçš„æˆ–è¼‰å…¥å¤±æ•—ï¼'); }
            }).catch(err => { showLoading(false, false); alert('è¼‰å…¥åœ–ç‰‡é›†å¤±æ•—ï¼š' + err); });
        }

        function closeImageViewer() {
            // å…³é—­å›¾ç‰‡æŸ¥çœ‹å™¨
            state.gallery.isOpen = false;
            imageViewer.classList.remove('active');
            document.body.style.overflow = 'auto'; // æ¢å¤èƒŒæ™¯æ»šåŠ¨
            currentImage.src = ""; // æ¸…ç©ºå›¾ç‰‡ï¼Œé‡Šæ”¾å†…å­˜
            currentImage.style.opacity = 0; currentImage.style.transform = 'none';
            currentImage.style.maxWidth = '100%'; currentImage.style.maxHeight = '100%';
            viewerState.rotationAngle = 0; // é‡ç½®æ—‹è½¬è§’åº¦
            if (document.fullscreenElement) { document.exitFullscreen(); } // å¦‚æœæ˜¯å…¨å±çŠ¶æ€åˆ™é€€å‡º
        }
        
        function displayImage(index) {
            // åœ¨å›¾ç‰‡æŸ¥çœ‹å™¨ä¸­æ˜¾ç¤ºæŒ‡å®šç´¢å¼•çš„å›¾ç‰‡
            if (!state.gallery.isOpen || state.gallery.isLoading || index < 0 || index >= state.gallery.files.length) return;
            state.gallery.isLoading = true;
            currentImage.style.opacity = 0; // å…ˆéšè—å½“å‰å›¾ç‰‡
            applyImageViewerTransforms(); // åº”ç”¨å˜æ¢
            setTimeout(() => { // ä½¿ç”¨ setTimeout æä¾›ä¸€ä¸ªçŸ­æš‚çš„è¿‡æ¸¡æ•ˆæœ
                const type = 'pages'; // Mangaæ¨¡å¼ä¸‹æ˜¯'pages'
                const imageName = state.gallery.files[index];
                // æ„å»ºå›¾ç‰‡URL
                const imageUrl = `/api/media/${state.mode}/${type}/${state.gallery.baseMediaPath}/${imageName}`;
                currentImage.src = imageUrl;
                currentImage.onload = () => { // å›¾ç‰‡åŠ è½½æˆåŠŸå
                    currentImage.style.opacity = 1; // æ·¡å…¥æ˜¾ç¤ºæ–°å›¾ç‰‡
                    state.gallery.currentIndex = index; // æ›´æ–°å½“å‰ç´¢å¼•
                    updateProgressBar(); // æ›´æ–°è¿›åº¦æ¡é«˜äº®
                    preloadNextImage(); // é¢„åŠ è½½ä¸‹ä¸€å¼ å›¾ç‰‡
                    state.gallery.isLoading = false;
                    applyImageViewerTransforms(); // å†æ¬¡åº”ç”¨å˜æ¢ä»¥ç¡®ä¿å°ºå¯¸æ­£ç¡®
                };
                currentImage.onerror = () => { state.gallery.isLoading = false; }
            }, 200);
        }

        async function goBack() {
            // è¿”å›ä¸Šä¸€çº§æˆ–é€€å‡ºæœç´¢
            if (state.isTagEditMode && !await confirmExitTagEditMode()) return;
            if (state.inSearchMode) { // å¦‚æœåœ¨æœç´¢æ¨¡å¼ä¸‹ï¼Œè¿”å›æ“ä½œæ˜¯é€€å‡ºæœç´¢ï¼Œå›åˆ°æœç´¢å‰çš„ç›®å½•
                state.inSearchMode = false; searchInput.value = '';
                const targetPath = state.pathStack.length > 0 ? state.pathStack[state.pathStack.length - 1] : '';
                browse(targetPath); return;
            }
            if (state.pathStack.length > 1) { // å¦‚æœåœ¨æµè§ˆæ¨¡å¼ä¸‹ï¼Œä»è·¯å¾„æ ˆä¸­å¼¹å‡ºä¸Šä¸€çº§è·¯å¾„å¹¶æµè§ˆ
                state.pathStack.pop(); 
                const prevPath = state.pathStack[state.pathStack.length - 1]; 
                browse(prevPath); 
            }
        }
        
        function preloadNextImage() {
            // é¢„åŠ è½½ä¸‹ä¸€å¼ å›¾ç‰‡ä»¥æå‡ç”¨æˆ·ä½“éªŒ
            const nextIndex = state.gallery.currentIndex + 1;
            if (nextIndex < state.gallery.files.length) {
                const type = 'pages';
                const nextImageName = state.gallery.files[nextIndex];
                const nextImageUrl = `/api/media/${state.mode}/${type}/${state.gallery.baseMediaPath}/${nextImageName}`;
                new Image().src = nextImageUrl; // åˆ›å»ºä¸€ä¸ªæ–°çš„Imageå¯¹è±¡æ¥åŠ è½½å›¾ç‰‡ï¼Œä¼šç¼“å­˜åˆ°æµè§ˆå™¨
            }
        }
        
        function changeImage(direction) {
            // åˆ‡æ¢å›¾ç‰‡ï¼ˆä¸Šä¸€å¼ /ä¸‹ä¸€å¼ ï¼‰
            if (!state.gallery.isOpen) return; 
            const newIndex = state.gallery.currentIndex + direction; 
            displayImage(newIndex);
        }
        
        function buildProgressBar() {
            // æ„å»ºå›¾ç‰‡æŸ¥çœ‹å™¨å³ä¾§çš„è¿›åº¦æ¡
            progressBarContainer.innerHTML = '';
            for (let i = 0; i < state.gallery.files.length; i++) { 
                const segment = document.createElement('div'); 
                segment.className = 'progress-segment'; 
                progressBarContainer.appendChild(segment); 
            }
            // ä¸ºè¿›åº¦æ¡æ·»åŠ ç‚¹å‡»äº‹ä»¶ï¼Œå…è®¸ç›´æ¥è·³è½¬åˆ°å¯¹åº”å›¾ç‰‡
            progressBarContainer.addEventListener('click', (e) => {
                e.stopPropagation();
                if (e.target.classList.contains('progress-segment')) {
                    const segments = Array.from(progressBarContainer.children);
                    const clickedIndex = segments.indexOf(e.target);
                    if (clickedIndex !== -1) { displayImage(clickedIndex); }
                }
            });
        }
        
        function updateProgressBar() {
            // æ›´æ–°è¿›åº¦æ¡ï¼Œé«˜äº®æ˜¾ç¤ºå½“å‰å›¾ç‰‡å¯¹åº”çš„æ®µ
            const segments = progressBarContainer.children; 
            for (let i = 0; i < segments.length; i++) { 
                segments[i].classList.toggle('active', i === state.gallery.currentIndex); 
            }
        }
        
        function toggleFullscreen() {
            // åˆ‡æ¢æµè§ˆå™¨å…¨å±
            if (!document.fullscreenElement) { 
                document.documentElement.requestFullscreen(); 
            } else { 
                if (document.exitFullscreen) { document.exitFullscreen(); } 
            }
        }
        
        function openVideoPlayer(mediaPath) {
            // æ‰“å¼€è§†é¢‘æ’­æ”¾å™¨
            const videoUrl = `/api/media/JAV/video/${mediaPath}`; 
            videoPlayer.classList.add('active'); 
            document.body.style.overflow = 'hidden'; 
            currentVideo.src = videoUrl;
        }
        
        function closeVideoPlayer() {
            // å…³é—­è§†é¢‘æ’­æ”¾å™¨
            videoPlayer.classList.remove('active'); 
            document.body.style.overflow = 'auto'; 
            currentVideo.pause(); 
            currentVideo.src = "";
        }

        // --- äº‹ä»¶ç›‘å¬å™¨ ---
        
        modeSwitchBtn.addEventListener('click', async () => { 
            // æ¨¡å¼åˆ‡æ¢æŒ‰é’®
            if (state.isTagEditMode && !await confirmExitTagEditMode()) return;
            state.mode = state.mode === 'MANGA' ? 'JAV' : 'MANGA';
            modeSwitchBtn.textContent = state.mode === 'MANGA' ? 'åˆ‡æ¢è‡³ JAV æ¨¡å¼' : 'åˆ‡æ¢è‡³ MANGA æ¨¡å¼';
            mediaContainer.className = state.mode === 'MANGA' ? 'manga-mode' : 'jav-mode';
            state.pathStack = []; // åˆ‡æ¢æ¨¡å¼åé‡ç½®è·¯å¾„æ ˆ
            state.inSearchMode = false;
            browse(); // é‡æ–°ä»æ ¹ç›®å½•å¼€å§‹æµè§ˆ
        });

        searchBtn.addEventListener('click', () => search(searchInput.value));
        searchInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') search(searchInput.value); });
        
        mediaContainer.addEventListener('click', (e) => {
            // å¡ç‰‡å®¹å™¨çš„ç‚¹å‡»äº‹ä»¶ä»£ç†
            if (state.isTagEditMode) return; // ç¼–è¾‘æ¨¡å¼ä¸‹ç¦ç”¨å¡ç‰‡ç‚¹å‡»
            const card = e.target.closest('.card');
            if(!card) return;
            // å¦‚æœç‚¹å‡»çš„æ˜¯å›¾ç‰‡åŒºåŸŸï¼Œæˆ–è€…ä¸æ˜¯ç‰¹æ®Šç›®å½•ï¼Œåˆ™è§¦å‘æ‰“å¼€è¡Œä¸º
            const imageWrapper = e.target.closest('.card-image-wrapper');
            if (imageWrapper || !card.dataset.isSpecialDir) {
                const fullPath = card.dataset.path;
                const mediaPath = card.dataset.mediaPath;
                const isSpecialDir = card.dataset.isSpecialDir === 'true';
                const isDir = card.dataset.isDir === 'true';
                if (isSpecialDir) { // ç‚¹å‡»ç‰¹æ®Šç›®å½•ï¼ˆå¦‚ a_ï¼‰ï¼Œæ‰“å¼€å›¾ç‰‡æŸ¥çœ‹å™¨
                    openImageViewer(fullPath, mediaPath);
                } else if (isDir) { // ç‚¹å‡»æ™®é€šç›®å½•ï¼Œè¿›å…¥è¯¥ç›®å½•
                    browse(fullPath);
                } else { // ç‚¹å‡»æ–‡ä»¶
                    if (state.mode === 'JAV') { // JAVæ¨¡å¼ä¸‹ç‚¹å‡»æ–‡ä»¶æ’­æ”¾è§†é¢‘
                        openVideoPlayer(mediaPath);
                    } else {
                        alert(`é»æ“Šäº†æª”æ¡ˆï¼š${fullPath}\næ­¤é¡æª”æ¡ˆçš„é»æ“Šè¡Œç‚ºå°šæœªå®šç¾©ã€‚`);
                    }
                }
            }
        });

        openFolderBtn.addEventListener('click', async () => {
            // "æ‰“å¼€æ‰€åœ¨ç›®å½•" æŒ‰é’®
            if (!state.inSearchMode && state.pathStack.length > 0) {
                const currentDir = state.pathStack[state.pathStack.length - 1];
                const url = `/api/open_folder?path=${encodeURIComponent(currentDir)}`;
                try {
                    await fetch(url);
                } catch (error) { console.error("Failed to open folder:", error); alert("æ‰“é–‹è³‡æ–™å¤¾å¤±æ•—ã€‚"); }
            } else { alert("ç„¡æ³•åœ¨æœç´¢çµæœé é¢æ‰“é–‹ç›®éŒ„ã€‚"); }
        });

        document.addEventListener('keydown', (e) => {
            // å…¨å±€é”®ç›˜äº‹ä»¶
            if (state.gallery.isOpen) { // å›¾ç‰‡æŸ¥çœ‹å™¨æ‰“å¼€æ—¶
                if (e.key === 'ArrowRight') changeImage(1); // å³ç®­å¤´ -> ä¸‹ä¸€å¼ 
                else if (e.key === 'ArrowLeft') changeImage(-1); // å·¦ç®­å¤´ -> ä¸Šä¸€å¼ 
                else if (e.key === 'Escape') closeImageViewer(); // Esc -> å…³é—­
            } else if (videoPlayer.classList.contains('active')) { // è§†é¢‘æ’­æ”¾å™¨æ‰“å¼€æ—¶
                if (e.key === 'Escape') closeVideoPlayer(); // Esc -> å…³é—­
            }
        });
        
        // å›¾ç‰‡æŸ¥çœ‹å™¨å†…çš„äº¤äº’äº‹ä»¶
        imageContainer.addEventListener('click', () => changeImage(1)); // å·¦é”®ç‚¹å‡» -> ä¸‹ä¸€å¼ 
        imageContainer.addEventListener('contextmenu', (e) => { e.preventDefault(); changeImage(-1); }); // å³é”®ç‚¹å‡» -> ä¸Šä¸€å¼ 
        imageViewerCloseBtn.addEventListener('click', (e) => { e.stopPropagation(); closeImageViewer(); });
        videoPlayerCloseBtn.addEventListener('click', closeVideoPlayer);
        fullscreenBtn.addEventListener('click', (e) => { e.stopPropagation(); toggleFullscreen(); });
        document.addEventListener('fullscreenchange', () => { fullscreenBtn.textContent = document.fullscreenElement ? 'ï¦' : 'â›¶'; });
        
        document.body.addEventListener('contextmenu', (e) => {
            // åœ¨é¡µé¢ç©ºç™½å¤„å³é”®å•å‡» -> è¿”å›ä¸Šä¸€çº§
            // é˜»æ­¢åœ¨å¡ç‰‡æˆ–æŸ¥çœ‹å™¨ä¸Šè§¦å‘æ­¤è¡Œä¸º
            if (!imageViewer.classList.contains('active') && !videoPlayer.classList.contains('active')) {
                e.preventDefault();
                goBack();
            }
        });

        imageViewer.addEventListener('wheel', (e) => {
            // åœ¨å›¾ç‰‡æŸ¥çœ‹å™¨ä¸­æ»šåŠ¨é¼ æ ‡æ»šè½® -> æ—‹è½¬å›¾ç‰‡
            e.preventDefault(); e.stopPropagation();
            clearTimeout(wheelDebounceTimeout);
            // ä½¿ç”¨é˜²æŠ–ï¼Œé¿å…æ—‹è½¬è¿‡å¿«
            wheelDebounceTimeout = setTimeout(() => {
                currentImage.style.transition = 'none'; // æ—‹è½¬æ—¶æš‚æ—¶å–æ¶ˆè¿‡æ¸¡åŠ¨ç”»
                viewerState.rotationAngle = (viewerState.rotationAngle + (e.deltaY > 0 ? 90 : -90) + 360) % 360;
                applyImageViewerTransforms();
                setTimeout(() => { currentImage.style.transition = ''; }, 50); // ç¨åæ¢å¤è¿‡æ¸¡åŠ¨ç”»
            }, 100);
        });

        // --- ç»´æŠ¤èœå•äº‹ä»¶ç›‘å¬å™¨ ---
        maintenanceBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            if (state.isTagEditMode) { // å¦‚æœåœ¨ç¼–è¾‘æ¨¡å¼ï¼Œæ­¤æŒ‰é’®åŠŸèƒ½å˜ä¸º "ä¿å­˜"
                saveAndExitTagEditMode();
            } else { // æ­£å¸¸æ¨¡å¼ä¸‹ï¼Œåˆ‡æ¢ä¸‹æ‹‰èœå•çš„æ˜¾ç¤º
                maintenanceMenu.style.display = maintenanceMenu.style.display === 'block' ? 'none' : 'block';
            }
        });

        document.addEventListener('click', (e) => {
            // ç‚¹å‡»é¡µé¢å…¶ä»–åœ°æ–¹æ—¶ï¼Œå…³é—­ç»´æŠ¤èœå•
            if (!maintenanceBtn.contains(e.target) && !maintenanceMenu.contains(e.target)) {
                maintenanceMenu.style.display = 'none';
            }
        });

        editTagsBtn.addEventListener('click', () => {
            // "ç¼–è¾‘Tag" æŒ‰é’®
             if (state.isTagEditMode) { // å¦‚æœå·²åœ¨ç¼–è¾‘æ¨¡å¼ï¼Œåˆ™ä¿å­˜å¹¶é€€å‡º
                saveAndExitTagEditMode();
             } else { // å¦åˆ™ï¼Œè¿›å…¥ç¼–è¾‘æ¨¡å¼
                enterTagEditMode();
             }
        });
        
        generateCoversBtn.addEventListener('click', async () => {
            // "ç”Ÿæˆå°é¢" æŒ‰é’®
            maintenanceMenu.style.display = 'none';
            if (state.inSearchMode) {
                alert("è«‹åœ¨æ­£å¸¸çš„è³‡æ–™å¤¾ç€è¦½æ¨¡å¼ä¸‹ä½¿ç”¨æ­¤åŠŸèƒ½ï¼Œè€Œä¸æ˜¯åœ¨æœç´¢çµæœé é¢ã€‚");
                return;
            }
            if (confirm(`æ‚¨ç¢ºå®šè¦æƒæç•¶å‰ç›®éŒ„ï¼š\n"${state.currentPath}"\n\nä¸¦å°‡æ‰¾åˆ°çš„æ–°å°é¢ç”Ÿæˆåˆ°å°æ‡‰çš„ COVER è³‡æ–™å¤¾ä¸­å—ï¼Ÿ`)) {
                const options = {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ mode: state.mode, path: state.currentPath }),
                    clearContentOnLoad: false
                };
                const result = await fetchData('/api/generate_covers', options);
                if(result && result.status === 'started'){
                    alert("å°é¢ç”Ÿæˆä»»å‹™å·²åœ¨å¾Œå°é–‹å§‹ã€‚\nå®Œæˆå¾Œï¼Œè«‹æª¢æŸ¥å°é¢ç›®éŒ„ä¸‹çš„ 'temp_generated_covers' æ–‡ä»¶å¤¾ã€‚");
                } else {
                    alert("å•Ÿå‹•å°é¢ç”Ÿæˆä»»å‹™å¤±æ•—ã€‚è©³æƒ…è«‹æŸ¥çœ‹ä¼ºæœå™¨æ§åˆ¶å°æ—¥èªŒã€‚");
                }
            }
        });

        // --- åˆå§‹åŠ è½½ ---
        async function initialize() {
            // é¡µé¢é¦–æ¬¡åŠ è½½æ—¶æ‰§è¡Œçš„åˆå§‹åŒ–å‡½æ•°
            // é¦–å…ˆè·å–æ‰€æœ‰æ ‡ç­¾æ•°æ®
            state.tagsData = await fetch('/api/tags').then(res => res.json()).catch(() => ({}));
            // ç„¶åå¼€å§‹ä»æ ¹ç›®å½•æµè§ˆ
            browse();
        }

        initialize();
    });
    </script>
</body>
</html>