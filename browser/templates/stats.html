<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>访问统计</title>
    <style>
        :root {
            --background-color: #242424;
            --text-color: #FFFFFF;
            --button-color: #3B3B3B;
            --button-hover-color: #888888;
            --card-border-color: #333333;
            --font-family: 'Microsoft YaHei', 'Segoe UI', 'WenQuanYi Micro Hei', sans-serif;
        }
        body { background-color: var(--background-color); color: var(--text-color); font-family: var(--font-family); margin: 0; padding: 0; }
        .header-container { padding: 10px 20px; flex-shrink: 0; border-bottom: 1px solid var(--card-border-color); }
        .header { display: flex; justify-content: space-between; align-items: center; }
        .button { background-color: var(--button-color); color: var(--text-color); border: 1px solid var(--card-border-color); border-radius: 6px; padding: 8px 12px; font-size: 14px; cursor: pointer; transition: background-color 0.2s; text-decoration: none; }
        .button:hover { background-color: var(--button-hover-color); }
        .main-content { padding: 20px; }
        #stats-container { display: flex; flex-direction: column; gap: 2px; }

        .stat-row { padding-bottom: 8px; }
        .stat-label { font-size: 16px; font-weight: bold; word-break: break-all; margin-left: 5px; margin-bottom: 8px; }
        .stat-bar-wrapper { display: flex; align-items: center; gap: 10px; }
        .stat-bar-container { flex-grow: 1; }
        .stat-bar { display: flex; height: 28px; background-color: #3a3a3a; border-radius: 5px; overflow: hidden; align-items: center; }
        
        .stat-bar-segment {
            height: 100%; display: flex; align-items: center; justify-content: center;
            color: white; font-size: 12px; overflow: hidden;
            transition: filter 0.2s; position: relative;
        }
        .stat-bar-segment.expandable, .stat-bar-segment.clickable {
            cursor: pointer;
        }
        .stat-bar-segment.expandable:hover, .stat-bar-segment.clickable:hover {
            filter: brightness(1.2);
        }

        .segment-label {
            display: block; padding: 0 8px; white-space: nowrap;
            overflow: hidden; text-overflow: ellipsis; text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
        }
        .stat-total { font-size: 16px; font-weight: bold; min-width: 50px; text-align: right; }
        .drilldown-row { padding-top: 10px; }
        #loading-indicator { font-size: 24px; text-align: center; padding: 50px; }

        /* --- NEW: Copied viewer styles from index.html --- */
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.9); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .overlay.active { display: flex; }
        .overlay .close-btn { position: absolute; top: 20px; right: 30px; font-size: 40px; color: white; cursor: pointer; z-index: 1010; text-shadow: 0 0 5px black; }
        #image-viewer { flex-direction: row; padding: 20px; box-sizing: border-box; }
        #image-viewer .image-container { flex-grow: 1; display: flex; justify-content: center; align-items: center; height: 100%; }
        #image-viewer .image-container img { max-width: 100%; max-height: 100%; object-fit: contain; opacity: 0; transition: opacity 0.3s ease-in-out; }
        #image-viewer .progress-bar { width: 70px; height: 100%; display: flex; flex-direction: column; justify-content: center; padding: 0; box-sizing: border-box; gap: 1px; cursor: pointer; }
        .progress-segment-wrapper { display: flex; align-items: center; justify-content: flex-end; flex-grow: 1; }
        .progress-label { width: 30px; font-size: 10px; color: #cccccc; text-align: right; padding-right: 5px; flex-shrink: 0; }
        #image-viewer .progress-segment { flex-grow: 1; max-width: 15px; align-self: stretch; background-color: #555; border-radius: 2px; transition: background-color 0.2s; }
        #image-viewer .progress-segment.active { background-color: #3B8ED0; }
    </style>
</head>
<body>
    <div class="header-container">
        <div class="header">
            <a href="/" class="button">返回主页</a>
            <h1>作品访问统计</h1>
            <div></div>
        </div>
    </div>
    <div class="main-content">
        <div id="stats-container">
            <div id="loading-indicator">正在加载统计数据...</div>
        </div>
    </div>

    <div id="image-viewer" class="overlay">
        <span class="close-btn">&times;</span>
        <div class="image-container">
            <img id="current-image" src="" alt="viewer image">
        </div>
        <div id="progress-bar-container" class="progress-bar"></div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', async () => {
        const statsContainer = document.getElementById('stats-container');
        const loadingIndicator = document.getElementById('loading-indicator');
        const COLORS = ['#4e79a7', '#f28e2c', '#e15759', '#76b7b2', '#59a14f', '#edc949', '#af7aa1', '#ff9da7', '#9c755f', '#bab0ab'];

        // --- NEW: Copied viewer elements and state from index.html ---
        const imageViewer = document.getElementById('image-viewer');
        const imageContainer = imageViewer.querySelector('.image-container');
        const progressBarContainer = document.getElementById('progress-bar-container');
        const currentImage = document.getElementById('current-image');
        const imageViewerCloseBtn = imageViewer.querySelector('.close-btn');

        let galleryState = { isOpen: false, baseMediaPath: '', itemKey: '', files: [], currentIndex: 0, isLoading: false, mode: 'MANGA' };

        // --- NEW: Copied viewer JS functions from index.html ---
        function openImageViewer(fullPath, mediaPath, itemKey, mode, startIndex = 0) {
            loadingIndicator.style.display = 'block';
            const url = `/api/gallery?mode=${mode}&path=${encodeURIComponent(fullPath)}`;
            fetch(url).then(res => res.json()).then(files => {
                loadingIndicator.style.display = 'none';
                if (files && !files.error && files.length > 0) {
                    galleryState = { ...galleryState, isOpen: true, baseMediaPath: mediaPath, files: files, currentIndex: -1, itemKey: itemKey, mode: mode };
                    imageViewer.classList.add('active');
                    document.body.style.overflow = 'hidden';
                    buildProgressBar();
                    displayImage(startIndex);
                } else { alert('这个图片集是空的或载入失败！'); }
            }).catch(err => { loadingIndicator.style.display = 'none'; alert('载入图片集失败：' + err); });
        }

        function closeImageViewer() {
            galleryState.isOpen = false;
            imageViewer.classList.remove('active');
            document.body.style.overflow = 'auto';
            currentImage.src = "";
            currentImage.style.opacity = 0;
        }

        function displayImage(index) {
            if (!galleryState.isOpen || galleryState.isLoading || index < 0 || index >= galleryState.files.length) return;
            galleryState.isLoading = true;
            currentImage.style.opacity = 0;
            setTimeout(() => {
                const imageName = galleryState.files[index];
                const imageUrl = `/api/media/${galleryState.mode}/pages/${galleryState.baseMediaPath}/${imageName}`;
                currentImage.src = imageUrl;
                currentImage.onload = () => {
                    currentImage.style.opacity = 1;
                    galleryState.currentIndex = index;
                    updateProgressBar();
                    galleryState.isLoading = false;
                };
                currentImage.onerror = () => { galleryState.isLoading = false; }
            }, 200);
        }

        function buildProgressBar() {
            progressBarContainer.innerHTML = '';
            for (let i = 0; i < galleryState.files.length; i++) {
                const wrapper = document.createElement('div');
                wrapper.className = 'progress-segment-wrapper';
                const segment = document.createElement('div');
                segment.className = 'progress-segment';
                wrapper.appendChild(segment);
                wrapper.onclick = () => displayImage(i);
                progressBarContainer.appendChild(wrapper);
            }
        }

        function updateProgressBar() {
            const segments = progressBarContainer.querySelectorAll('.progress-segment');
            segments.forEach((seg, i) => seg.classList.toggle('active', i === galleryState.currentIndex));
        }

        imageViewerCloseBtn.addEventListener('click', closeImageViewer);
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && galleryState.isOpen) closeImageViewer();
        });


        /**
         * Renders the content of a drill-down bar with multiple segments.
         */
        function renderDrillDownBar(barElement, data, parentData) { // Now accepts parentData
            barElement.innerHTML = '';
            const limitedData = data.slice(0, 25);

            limitedData.forEach((child, index) => {
                const segment = document.createElement('div');
                segment.className = 'stat-bar-segment';
                segment.dataSource = child;

                const hasChildren = (child.children && child.children.length > 0) || (child.sub_children && child.sub_children.length > 0);
                
                // --- CORE MODIFICATION: Add click behavior for files/pages ---
                if (child.type === 'page') {
                    segment.classList.add('clickable');
                    segment.addEventListener('click', () => {
                        // Use parentData to get gallery info, and child for page index
                        openImageViewer(parentData.full_path, parentData.media_path, parentData.name, parentData.mode, child.page_index);
                    });
                } else if (hasChildren) {
                    segment.classList.add('expandable');
                    segment.addEventListener('click', handleSegmentClick);
                }
                
                const widthValue = child.aggregation_views || child.views || 0;
                segment.style.flex = `${widthValue} 1 0%`;
                segment.style.backgroundColor = COLORS[index % COLORS.length];
                
                let displayValue;
                if (child.type === 'directory') {
                    displayValue = child.ranking_views || 0;
                } else {
                    displayValue = child.views || child.aggregation_views || 0;
                }
                
                segment.title = `${child.name}: ${displayValue} 次`;

                const segmentLabel = document.createElement('span');
                segmentLabel.className = 'segment-label';
                segmentLabel.textContent = `${child.name} (${displayValue})`;
                segment.appendChild(segmentLabel);
                barElement.appendChild(segment);
            });
        }
        
        function removeAllSubsequentDrilldowns(startElement) {
            let currentElement = startElement;
            while (currentElement && currentElement.classList.contains('drilldown-row')) {
                const nextSibling = currentElement.nextElementSibling;
                currentElement.remove();
                currentElement = nextSibling;
            }
        }

        function handleSegmentClick(event) {
            event.stopPropagation();
            const segment = event.currentTarget;
            const data = segment.dataSource;
            const childrenData = data.children || data.sub_children;

            if (!childrenData || childrenData.length === 0) return;

            const parentRow = segment.closest('.stat-row');
            const nextElement = parentRow.nextElementSibling;
            const isDrilldownRow = nextElement && nextElement.classList.contains('drilldown-row');
            const segmentId = data.full_path || data.name;

            if (isDrilldownRow && nextElement.dataset.expandedBy === segmentId) {
                removeAllSubsequentDrilldowns(nextElement);
            } else {
                if (isDrilldownRow) {
                    removeAllSubsequentDrilldowns(nextElement);
                }

                const drilldownRow = document.createElement('div');
                drilldownRow.className = 'drilldown-row stat-row';
                drilldownRow.dataset.expandedBy = segmentId;
                
                const barWrapper = document.createElement('div');
                barWrapper.className = 'stat-bar-wrapper';
                const barContainer = document.createElement('div');
                barContainer.className = 'stat-bar-container';
                const newBar = document.createElement('div');
                newBar.className = 'stat-bar';
                newBar.style.width = '100%';

                // Pass parent data down to the next level
                renderDrillDownBar(newBar, childrenData, data);

                barContainer.appendChild(newBar);
                barWrapper.appendChild(barContainer);
                drilldownRow.appendChild(barWrapper);
                
                parentRow.insertAdjacentElement('afterend', drilldownRow);
            }
        }

        // --- Main Logic ---
        try {
            const response = await fetch('/api/structured_stats');
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            const statsData = await response.json();
            
            loadingIndicator.style.display = 'none';
            if (statsData.length === 0) {
                statsContainer.innerHTML = '<p>暂无任何访问记录。</p>';
                return;
            }

            const maxRankingViews = statsData.length > 0 ? Math.max(...statsData.map(item => item.ranking_views || 0)) : 0;

            statsData.forEach((item, itemIndex) => {
                const statRow = document.createElement('div');
                statRow.className = 'stat-row';

                const label = document.createElement('div');
                label.className = 'stat-label';
                label.textContent = item.name;

                const barWrapper = document.createElement('div');
                barWrapper.className = 'stat-bar-wrapper';
                
                const barContainer = document.createElement('div');
                barContainer.className = 'stat-bar-container';

                const bar = document.createElement('div');
                bar.className = 'stat-bar';

                if (maxRankingViews > 0) {
                    const widthPercentage = (item.ranking_views / maxRankingViews) * 100;
                    bar.style.width = `${widthPercentage}%`;
                } else {
                    bar.style.width = '0%';
                }

                const mainSegment = document.createElement('div');
                mainSegment.className = 'stat-bar-segment';
                mainSegment.style.width = '100%';
                mainSegment.style.backgroundColor = COLORS[itemIndex % COLORS.length];
                mainSegment.dataSource = item;

                const hasChildren = item.type === 'directory' && item.children && item.children.length > 0;
                if (hasChildren) {
                    mainSegment.classList.add('expandable');
                }
                mainSegment.addEventListener('click', handleSegmentClick);

                const mainLabel = document.createElement('span');
                mainLabel.className = 'segment-label';
                mainLabel.textContent = item.name;
                mainSegment.appendChild(mainLabel);
                
                bar.appendChild(mainSegment);

                const total = document.createElement('div');
                total.className = 'stat-total';
                total.textContent = item.ranking_views || 0;
                
                barContainer.appendChild(bar);
                barWrapper.appendChild(barContainer);
                barWrapper.appendChild(total);
                
                statRow.appendChild(label);
                statRow.appendChild(barWrapper);
                statsContainer.appendChild(statRow);
            });

        } catch (error) {
            loadingIndicator.textContent = `加载统计数据失败: ${error.message}`;
            console.error("Fetch stats error:", error);
        }
    });
    </script>
</body>
</html>